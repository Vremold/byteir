// RUN: byteir-opt %s -test-mhlo-canonicalize-ext -o %t
// RUN: FileCheck %s < %t
// RUN: python3 numerical_test.py %s %t

func.func @transpose_non_splat_constant() -> tensor<3x1x3x32x3xf32> {
  %0 = mhlo.constant dense<"0xD9D0BC3D7E9ABF3D0A64483ECD94B03DB0F313BEEC9275BBE4CC1E3E69A5823DD734E93C72F57FBC38B168BD649209BE13850EBC2AA7813E5A23893E0DD9B73D2436EEBC81FD6BBDCFB6FD3E806FE9BD139E36BE6DC9BD3E6DCA08BE3ADBC03DCE5C8A3DCE4258BE039CC03C5D6978BEBFA951BE67F969BE14AC9DBEE2CA75BEDB8FD33ECD77103E2CAEACBEDA10CE3D59B07BBC49E08FBD6F30A63E3DE7B73D872B4CBD7C33943DCAC14D3D0B9A613E74BEDABECB0D34BE98A150BE9F82BE3EDFC2DDBED59483BDD5DBA23EA8B7BABE717684BE3F8149BD681B773D33FB41BE33C8A4BCBE38FCBDDCF239BD9C9B713EDF68543EAB408D3E39B3473E863A1CBEEB48923E4857D93DE5F6773E9178E93DFF81013E219185BE3E916A3D6689FA3DAAC299BE9A112C3D92E948BEE53CAD3D690382BE2632433EDE7A003E3312C13E3340073E98C7B03C6764D03CBA790CBE8A4E8FBE698B0D3DE7BA9C3E874A2ABE5603E2BE3EB857BED1AB9DBDB34379BCF605AC3DC2BCCBBC0F2B9F3E658D15BC3B199ABE3EF3113E5854333D5E0194BD9441EE3D1F14D8BE0BACEC3B63D1693ECA03FE3E8ADF65BE3724F4BD268E45BE52024F3E35F7843E4E7E3CBE28B3EBBDFD250E3ED472B3BDB8C880BDBF51413E5D46B63DE29008BD4950043D5343BEBE25333FBE048287BE2793653E679051BEF9258B3EDA414FBE79487DBE78F6523E8475DF3EED39CC3EC2019ABE52CBA3BD48BF6E3EB0DFF1BEAF24D3BD7B2E2ABD7F25A83D960FF1BCFAE4DB3CA8EDB3BEEC8559BEC40B983C88EF813D59DA15BE2C92A53E145336BD464F793CBD3DC4BEE271D8BD94CFD53E015DBE3EC25A9A3E831BA23E0C3F7C3EF36CAE3EFC69903E919FBBBE3E0ACABEB1456B3C41986C3EE7C42ABD5642853E2F58E23D88A0843EFE2E32BE77FBAE3E813EA23E8BCDA63DF2FB843E8C767B3E42CF42BE81307C3EBC1F87BEA3C3A33E6CD3883E25F3E03DA9E1F0BD4C1BB7BE833E223C6CC615BE97C59B3D1F344DBDC48C7EBE082EFE3CA2ABEABDFD5E4F3E009AB53C8251BABEBAD1053E5B8784BEE6EC81BEB902F3BD812A193E98D613BD6D7CB9BEE5F52C3EA1989ABCF224A6BC6788B93C01F888BE59AD05BE5A9B633E6222863ED269A03DD180553E6D1FB83DA37220BEB611FC3CABDE9E3EEB07943E4CEB99BD8353D2BE2C84A43E15F268BDF332663E96370DBDF333D3BECC93A5BEE05ED6BD8F0B473D36AE043F4FFDEEBD9FE6A53E73EB60BE17E13D3E67EFA73E16744DBE5AE788BEA88B76BEB4B5023B8E7F0EBEEE4B3D3E1D31DBBE2CDF5B3DE508A73D38E01FBE026F163CB8AF8FBDC1C0353D48DC5F3E2F82D73D45F8EFBD426205BE8780733BF65E173E653D253D13D60B3D2E067FBD15F0173EE535FB3C919FE03DCD7E95BE98B0C03C89764F3E89905C3EC12923BE486746BE44FD54BCB7B88D3E146C06BE117B93BE92BABBBEA18C633D5C567A3EFC8A383E97EEC5BED71F523EC68C8F3E8644A8BE39DD2CBE1E520DBE47C4453EB7BA343EC859B4BE0655083CB7DCD3BD2D0C7EBE55E7473E7FEABC3D212E38BC82AD27BEAB839CBEA9B4B23E8397003E182FDBBC0E31A03D866CA7BEE29E623E4EA580BEB9D2BB3E2432F8BD750C82BE93D4FB3DD2D15BBDB889403E3765DC3D7424A43BAD5D503E09E313BECD90273E559CBFBE3B73C7BE29CDD7BC6E809ABD28E893BEF8CA883DD1D80DBEEA13A53E7C543EBC30FBB53E979FA43CF2C4D93E37BACC3D8D88073D012DCC3DC5B374BDCA22C4BE3CDE81BE07A4CB3D9F8046BEB1F338BE810C573DE0C6843BCEE688BC9994383EBB14383C9AB6BD3E3BFC9A3EBE8D2BBC2A0D893E7F27183E24E0E13D29C8A9BE004DD7BEB085393DFB8249BED022823C8E2A7DBD906CEB3D37146EBE97E1CD3E12A4ECBD73728DBD861EE1BD0C8E3B3EC462943DDBE99D3E53A59D3D058434BE2FD7DE3E26CBB83D5D91E0BEEC82A63E2E02BCBEA10006BE9BC071BED631FD3EA1AFA13EEF1B87BCC802B73D04FDDC3D333E4DBEC0D8A3BEBBD3903E77E68C3DF01FA6BECD9ADF3EAB9382BD8B31B63DB981113EFB54AF3EC5115C3ECCA6C1BE5A96A93D7C09E23E44DDB93EFD509C3EC77F4FBEF0F3803E851C3CBE9532F3BE5A1C243E8C4B823EB52F913D0AB938BE96451A3EA91289BE7ED73A3E1BA72E3ECE0CABBDF71315BD4A5B0FBB70C704BEF476C6BE05EB783B4F408ABD4B0ECD3D72FB42BE4734E83E7FF641BEB3D09FBD1F07B2BED327083E4117D3BC7DE9A1BE19E66CBE302C8A3D72EF913D813837BE4C71003F5EA02A3C8EF204BE92716DBE91189EBD6CF86E3E76274ABE2A0F8CBD84DEFC3E7DF9913DC3E0F63D82EC023A811A653E309FF1BDC94344BEDEC5A8BE7E6D2ABC6AD3EBBC1609D4BEA415B53EB45930BDC6F958BC8171F63DB3BD4C3C45BE2FBE5DF1D7BE7DBF31BD31B9813EE917023D1E03593EA77B983EA29CB93EF1F91ABE996347BE9837193E11DDCBBE64DEC93E7A86D2BEFC431A3E2F0020BECBC9F43E34118BBE891541BE6564023E8F1465BC632EB83E053C85BE52EE1B3E3A3D2CBDD6BD36BDAFB1B7BE5968153E763FA43ECBE5823B8BF582BE691D3DBE1B4931BE63FB94BE509EA8BD753BA23EC8505F3E1F8F1CBD1CD2F3BDE53894BE1B1ACDBD4EC1663EF483FBBB935EFFBE2B21653DAA883FB94EBD4CBE8822573E35ECB13E6B6646BCE00270BD1084AFBD83DF733D6F48CCBDA428F6BE75FA9C3CEDE568BC7C803B3E0BC08DBDD9990E3E9A76EABE4E4805BBB8D681BEEA13A93EF626A0BEDA2F823D1B4C38BEDDE18ABEC7FF8B3D149C453EDCB548BDF5E12BBDD69FC53D28C7B7BD451079BD0E6580BDD711893E6C6D863D5288D23D4E59A4BD79019EBE2E2CADBE5B2391BE0E3D70BE2CE70DBD8FA13D3E9388EA3DC499AFBEACFEA23EF30F383EF30FC23DD5418F3EC17EA83E5BF3393D68E6A6BD8CEBE63DEEF789BC42FB9FBEAAA4963D6E11A23D148E2C3EB94DF0BDE79B5F3D6C72C13ECC4E223D5192BA3EBAFB1C3DADD991BD305E6EBD7E1A3F3EF219DE3E75DDB5BED9F9253E316AB6BD389A2ABEA90192BEA0D342BDFEE876BDDEC218BEC59C663EB56F02BE30AACBBBE47EC7BE34C41C3DDC8709BE17D0133E49CFBDBDFCB7343E67869EBEDD17EEBE44989CBEFD380DBEF15EF8BE04D502BD13783FBE0B51AA3E73F88E3DAA2156BEFF17D6BE986521BED297AB3D4161843EB925B5BDF2FCEA3E4B5381BEAD8239BE32F29FBCFCA985BDAF8E043F319C583DEB1B3ABD5B83343E471D323B2530AABD8CDDC5BD61E9D9BD968359BED0303A3CECF4D63D74C008BE1ACB0ABD908834BD8052263D319E99BE3DECDCBDA7F3F7BE4F1462BE76AD093F06D1853E36A001BEC02EEE3DAFEFB73DB509CEBE60FF033ED2AB223ECE5DD2BD7F7953BE41956D3E6D9FC03EC4E34FBC911D29BEF453A43E9AF25D3E89355BBDC8922C3E8433F0BE0A66A2BEA0E8E13D8443AC3C170586BEE263253E1089A1BE0BB4543E0767BCBC11272DBEC319643EFE3A74BEB339E8BE1938C23E5DC750BD91AB533E6F60AABDEDFB513E65DA1ABE04ABC9BDE3CCC13E6CC4E83E8DE9DD3DA0EF2A3E1634FABD51E479BD8C6AC93EA87EBFBE675F55BEEE8FBABE11A0B8BD6E8DD8BD3DA406BD705E0ABE8A37293E0782403E372B3C3E5AD6B0BDE6CC80BEBD47E03C9A0E0DBECBF4F0BD51B4013FCCE5B6BED7BAAF3E9D42163D1CDF9CBCCEAC613ED7CAF33D5A2625BE50B38F3E32D7DDBDB28576BDFDE0A53E91AFB93DADB99A3E27D9D0BE45785FBEB9CE67BE16597DBE132B94BE6C9190BEF89FFD3E32F3AB3D74278C3E13EFC5BEF9E7563E3CC7B53E9AED7ABCDEF081BE95B802BEFBBB1B3EE0DA0E3E0AC1B0BEF7C9F23ECAA15D3E68265BBDC1A7873DEF9F4C3E571F74BED9D5F23EB5B510BDD4CEEEBD0D89A83DBFDFADBE79DDAE3DCEA5D33E579AB53E33E5633EEF8B90BE23AD15BE0FAF103CED3322BBA382B63D3C158CBDBE5EB53D6B122E3E106DFA3D0A6204BE516BB9BAFAAF69BEE88B553C0CE4CE3D507BAB3D464F313E709B93BE37C9A8BE3706363D4B315FBECB9AAD3EB2169BBD609D82BBD0F5DF3D665E1D3E29BCA9BEF9C4EEBD599BA4BDE9BF41BE2F2F35BEFAA7C53C8CCDC03E1C7809BDF781DDBE53E3D9BE8A72B7BD6D0078BE877D903EA098DABAA634D53C6295FDBDAA539D3E8DD0D33D1A158E3DB890003EACDDD9BD5ABE4B3D80CD0B3DA6E1413E1497913EBDCAAA3DB46CA8BD08771DBEDF7DD83D9803D0BD74478B3D37C3E1BE3B3CD53B57E555BE0F5236BEA6A4003E2C83823E9A2CB6BE955FAB3E500ED03D4ACF423DA50C843EE204E23E63E18ABDDB72033EB329553EE222C83E825F0F3E2C37383EA48C093D7B4849BE9C88F7BD70D77DBDA0B2693DBD9DB4BDB4C9893E4BE9D33E1C35A7BEB92527BEBD15893B2AB0C3BD27B3DEBDE345F03E3FFEB23D907185BEB2EF35BEE54EAF3ED0595DBEEC6E92BC5B69CF3D13A6523E94E455BE1007AE3C85CCE13EA17CCC3E1AC5993E372C7F3ED613993E51C456BE371D85BD503952BE5666D23DEA8CC7BE165689BD4932843E42181EBE87AA843E4BB7913DF124913E1605D03ED9FA043D3BD3D43D88096FBD0DD9BD3EC927CC3E98DCB83CD47D48BE100E05BE7298BBBD9E3B8BBDE919E33D1404833D9362023EF426EB3EB6F18A3B3880723EB5F8A6BED7B7A6BC2041163ED10B033EE98678BE3F1F933D65856BBE897C2E3DD5EF083E3C8F42BEC72C97BE9A16D0BED333993E11BD21BE2A2236BDFC6C9E3EB0F5AFBD6CA761BE5CC889BEC432B53E7F4A7EBDF541B53E242B39BEF742673E885471BC6819413D"> : tensor<1x3x3x3x32xf32>
  %1 = "mhlo.transpose"(%0) {permutation = dense<[1, 0, 2, 4, 3]> : tensor<5xi64>} : (tensor<1x3x3x3x32xf32>) -> tensor<3x1x3x32x3xf32>
  func.return %1 : tensor<3x1x3x32x3xf32>
}
// CHECK-LABEL: transpose_non_splat_constant
// CHECK-NOT: mhlo.transpose

func.func @fold_useless_shape_broadcast(%arg0: tensor<?x4xf32>) -> tensor<?x4xf32> {
  %0 = shape.const_shape [4] : tensor<1xindex>
  %1 = mhlo.constant dense<[[-0.570340514, 0.117151208, -0.135694504, -1.57919896], [0.520053327, 0.762166619, 0.322875232, -1.69871449], [-1.26622009, 0.63558042, 5.698780e-01, 0.954656243], [0.776482939, 0.348752886, 2.03235912, 0.837243676]]> : tensor<4x4xf32>
  %2 = "mhlo.dot"(%arg0, %1) : (tensor<?x4xf32>, tensor<4x4xf32>) -> tensor<?x4xf32>
  %3 = shape.shape_of %2 : tensor<?x4xf32> -> tensor<2xindex>
  %4 = shape.broadcast %3, %0 : tensor<2xindex>, tensor<1xindex> -> tensor<2xindex>
  %5 = "mhlo.dynamic_broadcast_in_dim"(%2, %4) {broadcast_dimensions = dense<[0, 1]> : tensor<2xi64>} : (tensor<?x4xf32>, tensor<2xindex>) -> tensor<?x4xf32>
  return %5 : tensor<?x4xf32>
}
// CHECK-LABEL: fold_useless_shape_broadcast
// CHECK-NOT: shape.broadcast

func.func @fold_concat_of_continuous_slices(%arg0: tensor<4x11xf32>) -> tensor<4x11xf32> {
  %0 = "mhlo.slice"(%arg0) {limit_indices = dense<[4, 7]> : tensor<2xi64>, start_indices = dense<[0, 5]> : tensor<2xi64>, strides = dense<1> : tensor<2xi64>} : (tensor<4x11xf32>) -> tensor<4x2xf32>
  %1 = "mhlo.slice"(%arg0) {limit_indices = dense<[4, 11]> : tensor<2xi64>, start_indices = dense<[0, 7]> : tensor<2xi64>, strides = dense<1> : tensor<2xi64>} : (tensor<4x11xf32>) -> tensor<4x4xf32>
  %2 = "mhlo.slice"(%arg0) {limit_indices = dense<[4, 5]> : tensor<2xi64>, start_indices = dense<0> : tensor<2xi64>, strides = dense<1> : tensor<2xi64>} : (tensor<4x11xf32>) -> tensor<4x5xf32>
  %3 = "mhlo.concatenate"(%2, %0, %1) {dimension = 1 : i64} : (tensor<4x5xf32>, tensor<4x2xf32>, tensor<4x4xf32>) -> tensor<4x11xf32>
  return %3 : tensor<4x11xf32> 
}
// CHECK-LABEL: func.func @fold_concat_of_continuous_slices
// CHECK-SAME: (%[[ARG0:.*]]: tensor<4x11xf32>)
// CHECK-NEXT: return %[[ARG0]] : tensor<4x11xf32>

